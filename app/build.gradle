/*
 * This file was generated by the Gradle 'init' task.
 *
 * This generated file contains a sample Java application project to get you started.
 * For more details on building Java & JVM projects, please refer to https://docs.gradle.org/8.13/userguide/building_java_projects.html in the Gradle documentation.
 * This project uses @Incubating APIs which are subject to change.
 */

plugins {
    // Apply the application plugin to add support for building a CLI application in Java.
    id 'application'
    id 'org.openjfx.javafxplugin' version '0.1.0'
}
version = '1.0.2'
def cmsg = "Version v${version}"
repositories {
    // Use Maven Central for resolving dependencies.
    mavenCentral()
}

dependencies {
    implementation libs.guava
    implementation group: 'com.google.code.gson', name: 'gson', version: '2.13.0'
    def javafxVersion = '21'
    def javafxModules = ['base', 'graphics', 'controls', 'fxml']

    javafxModules.each { module ->
        ['win', 'linux', 'mac'].each { platform ->
            runtimeOnly "org.openjfx:javafx-${module}:${javafxVersion}:${platform}"
        }
    }
}

tasks.register('copyJavafxLibs', Copy) {
    group = 'build'
    description = 'Copies JavaFX libraries to build dir'

    from {
        configurations.runtimeClasspath.filter {
            it.name.contains('javafx') && it.name.endsWith('.jar')
        }
    }
    into "$buildDir/javafx-libs"
}

javafx {
    version = "21"
    modules = ['javafx.controls', 'javafx.fxml']
}

testing {
    suites {
        // Configure the built-in test suite
        test {
            // Use JUnit Jupiter test framework
            useJUnitJupiter('5.11.3')
        }
    }
}

tasks.register('runPackScript', Exec) {
    dependsOn 'mkJar', 'copyJavafxLibs'
    group = 'build'
    description = 'Runs the packaging script to create tarball'

    executable 'bash'
    args '/Users/william/coding/grl/package.sh'
}
tasks.register('packapp', Exec) {
    dependsOn 'runPackScript'
    group = 'build'
    description = 'Runs the packaging script to create .app macOS app file Universal'

    executable 'bash'
    args '/Users/william/coding/grl/app-pkg.sh'
}
// Apply a specific Java toolchain to ease working on different environments.
java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(21)
    }
}

application {
    // Define the main class for the application.
    mainClass = 'org.example.App'
}

tasks.register('mkJar', Jar) {
    dependsOn classes
    group = 'build'
    description = 'Creates fat JAR with dependencies'

    duplicatesStrategy = DuplicatesStrategy.EXCLUDE
    archiveClassifier.set('all')

    manifest {
        attributes('Main-Class': application.mainClass.get())
    }

    from {
        configurations.runtimeClasspath.collect { it.isDirectory() ? it : zipTree(it) }
    }
    from sourceSets.main.output
}

tasks.named('build') {
    dependsOn 'upload'
}

task upload(type: Exec) {
    dependsOn packapp
    commandLine 'bash', '-c', "git add . && git commit -m '${cmsg}' && git tag -f ${version} && git push -f origin ${version} && git push origin main"
}

task publish(type: Exec) {
    dependsOn upload
    doFirst {
        println '⚠️ WARNING: You are about to create a GitHub release. Continue? (y/n)'
        def scanner = new Scanner(System.in)
        def answer = scanner.nextLine()
        if (answer != 'y') {
            throw new GradleException('Publish aborted by user.')
        }
    }
    commandLine 'gh', 'release', 'create', version, '~/coding/grl/OSpkg/morning.app.zip', '--generate-notes', '--latest=true'
}